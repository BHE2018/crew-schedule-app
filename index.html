<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Horario del equipo & Job Form</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html { -webkit-tap-highlight-color: transparent; }
    input, select, textarea { font-size: 16px; } /* evita zoom en iOS */
    /* Botón verde metálico */
    .btn-green {
      background: linear-gradient(180deg, #8fd694 0%, #34c759 45%, #0b7f3b 100%);
      color: #fff; border: 1px solid #0b7f3b;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35), 0 4px 10px rgba(0,0,0,.12);
    }
    .btn-green:hover { filter: brightness(1.05); }
    .btn-green:active { transform: translateY(1px); }
    .btn-link-green { color:#0e8f45; }
    .btn-link-green:hover { text-decoration: underline; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <div class="max-w-md mx-auto min-h-screen p-4">
    <!-- Header -->
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">Horario del equipo</h1>
      <div class="flex items-center gap-2">
        <span id="modePill" class="hidden text-[10px] px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 border border-amber-300">DEMO</span>
        <span id="version" class="text-xs text-slate-500">v1.3</span>
      </div>
    </header>

    <!-- Crew picker -->
    <section class="mb-4">
      <label for="crewSelect" class="block text-sm font-medium mb-2">Selecciona tu nombre</label>
      <select id="crewSelect" class="w-full rounded-2xl border border-slate-300 bg-white p-3 shadow-sm focus:ring-2 focus:ring-indigo-500">
        <option value="" disabled selected>Elige tu nombre…</option>
      </select>
    </section>

    <!-- Schedule -->
    <section id="scheduleSection" class="hidden">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Tu siguiente trabajo</h2>
        <button id="refreshBtn" class="text-sm btn-link-green underline">Actualizar</button>
      </div>
      <p id="diag" class="text-xs text-slate-500 mb-2 hidden"></p>
      <ul id="scheduleList" class="space-y-2"></ul>
    </section>

    <!-- Empty -->
    <section id="emptyState" class="hidden text-center py-16">
      <p class="text-slate-500">No hay trabajos asignados para hoy.</p>
    </section>

    <!-- Modal (Job form) -->
    <div id="modal" class="fixed inset-0 bg-black/40 hidden items-end sm:items-center sm:justify-center z-50">
      <div class="w-full sm:max-w-md bg-white rounded-t-3xl sm:rounded-3xl p-4 sm:p-6 shadow-xl">
        <div class="flex items-center justify-between mb-3">
          <h3 id="modalTitle" class="text-xl font-semibold">Detalles del trabajo</h3>
          <button id="closeModal" class="rounded-full p-2 hover:bg-slate-100" aria-label="Cerrar">✕</button>
        </div>
        <!-- Línea con el vendedor/rep -->
        <div id="repLine" class="text-sm text-slate-600 mb-2"></div>

        <form id="jobForm" class="space-y-4">
          <!-- Hidden -->
          <input type="hidden" id="jobId" />
          <input type="hidden" id="jobNumber" />
          <input type="hidden" id="jobAddress" />
          <input type="hidden" id="jobRep" />

          <!-- Team multi-select -->
          <div>
            <label class="block text-sm font-medium mb-1">Otros miembros del equipo (selección múltiple)</label>
            <div id="crewPicker" class="relative">
              <button id="crewDropdownBtn" type="button" class="w-full flex items-center justify-between rounded-xl border border-slate-300 p-3 bg-white">
                <span id="crewDropdownPlaceholder" class="text-slate-400">Toca para seleccionar…</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.06l3.71-3.83a.75.75 0 111.08 1.04l-4.24 4.38a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
              </button>
              <div id="crewTokens" class="flex flex-wrap gap-2 mt-2"></div>
              <div id="crewDropdown" class="absolute left-0 right-0 mt-2 bg-white border border-slate-300 rounded-2xl shadow-xl z-50 hidden">
                <div class="p-2 border-b border-slate-200">
                  <input id="crewSearch" type="text" class="w-full rounded-lg border border-slate-300 p-2" placeholder="Buscar nombres…" />
                </div>
                <ul id="crewOptions" class="max-h-64 overflow-auto divide-y divide-slate-100"></ul>
              </div>
            </div>
          </div>

          <!-- Times -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="startTime" class="block text-sm font-medium mb-1">Inicio</label>
              <input id="startTime" type="time" class="w-full rounded-xl border border-slate-300 p-3" required />
            </div>
            <div>
              <label for="endTime" class="block text-sm font-medium mb-1">Fin</label>
              <input id="endTime" type="time" class="w-full rounded-xl border border-slate-300 p-3" required />
            </div>
          </div>

          <!-- Damage / notes -->
          <div>
            <label for="damageNotes" class="block text-sm font-medium mb-1">Daños / Notas (mín. 10 caracteres)</label>
            <textarea id="damageNotes" rows="3" class="w-full rounded-xl border border-slate-300 p-3" required minlength="10" placeholder="Describe daños o notas… (mín. 10 caracteres)"></textarea>
          </div>

          <!-- Status -->
          <div>
            <label for="status" class="block text-sm font-medium mb-1">Estado del trabajo</label>
            <select id="status" class="w-full rounded-xl border border-slate-300 p-3" required>
              <option value="" disabled selected>Selecciona el estado…</option>
              <option>Completo</option>
              <option>Pendiente</option>
              <option>Tocón pendiente</option>
            </select>
          </div>

          <!-- Payment -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="paymentCollected" class="block text-sm font-medium mb-1">¿Se cobró el pago?</label>
              <select id="paymentCollected" class="w-full rounded-xl border border-slate-300 p-3" required>
                <option value="" disabled selected>Seleccionar…</option>
                <option value="Sí">Sí</option>
                <option value="No">No</option>
              </select>
            </div>
            <div>
              <label for="paymentType" class="block text-sm font-medium mb-1">Tipo de pago</label>
              <select id="paymentType" class="w-full rounded-xl border border-slate-300 p-3" disabled>
                <option value="" disabled selected>Selecciona el tipo…</option>
                <option>Efectivo</option>
                <option>Cheque</option>
                <option>Tarjeta</option>
                <option>Zelle</option>
              </select>
            </div>
          </div>

          <button type="submit" class="w-full rounded-2xl btn-green py-3 text-white font-semibold shadow-md active:scale-[.99]">Enviar</button>
        </form>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden bg-slate-900 text-white px-4 py-2 rounded-xl shadow-lg text-sm"></div>
  </div>

  <script>
    /* ===============================================
       CONFIG — Replace if your Web App URL changes
    ================================================*/
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyyU5vvp0c5NdJKdrGspMonHGDBxPpetRBzzT0imhIgJam4Co46mJyy3px6gJr_evLh/exec";

    // Globals
    let ALL_CREW = [];
    let TEAM_SELECTED = [];

    // Helpers
    const $ = (id) => document.getElementById(id);
    function diag(msg){ const el=$('diag'); if(el){ el.textContent=msg; el.classList.remove('hidden'); } console.log('[DIAG]', msg); }
    function showToast(msg){ const t=$('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2200); }
    function todayISO(){ return new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' }); } // yyyy-mm-dd

    // Load employees
    async function fetchCrew(){
      try{
        const res = await fetch(`${GAS_ENDPOINT}?action=getCrewList`);
        ALL_CREW = await res.json();
        const sel = $('crewSelect');
        sel.innerHTML = '<option value="" disabled selected>Elige tu nombre…</option>';
        (ALL_CREW || []).forEach(name => {
          const o=document.createElement('option'); o.value=name; o.textContent=name; sel.appendChild(o);
        });
        diag(`Empleados cargados: ${(ALL_CREW||[]).length}`);
      }catch(err){ diag('Error al cargar empleados'); console.error(err); }
    }

    // Get next job; if null, fall back to first job from schedule (so always show #1)
    async function fetchSchedule(crewName){
      if(!crewName) return;
      const date = todayISO();
      let job = null;

      try{
        const r1 = await fetch(`${GAS_ENDPOINT}?action=getNextJob&crew=${encodeURIComponent(crewName)}&date=${date}`);
        const d1 = await r1.json();
        if (d1 && (d1.jobId || d1.jobNumber || d1.address)) job = d1;
      }catch(e){ console.warn('getNextJob error', e); }

      if (!job) {
        try{
          const r2 = await fetch(`${GAS_ENDPOINT}?action=getSchedule&crew=${encodeURIComponent(crewName)}&date=${date}`);
          const d2 = await r2.json();
          if (Array.isArray(d2) && d2.length) job = d2[0];
        }catch(e){ console.warn('getSchedule error', e); }
      }

      const list = $('scheduleList');
      const empty = $('emptyState');
      const sect = $('scheduleSection');
      list.innerHTML = '';

      if (!job) {
        empty.classList.remove('hidden');
        sect.classList.add('hidden');
        diag(`[EN VIVO] ${crewName} @ ${date} → 0 trabajos`);
        return;
      }

      empty.classList.add('hidden');
      sect.classList.remove('hidden');

      // Card
      const li = document.createElement('li');
      li.className = 'p-4 rounded-xl border border-slate-200 bg-white shadow-sm cursor-pointer';
      li.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-semibold text-lg">${job.jobNumber || '(sin número)'}</div>
            <div class="text-sm text-emerald-700">Rep: ${(job.rep && String(job.rep).trim()) || '—'}</div>
            <div class="text-sm text-slate-600">${job.address || '(sin dirección)'}</div>
          </div>
          <button class="btn-green px-3 py-2 rounded-xl text-white text-sm font-semibold shadow-md active:scale-[.99]" id="openFormBtn">Llenar</button>
        </div>`
      ;
      list.appendChild(li);

      // Open modal on card or button
      const open = () => openJobModal(job);
      li.addEventListener('click', open);
      li.querySelector('#openFormBtn').addEventListener('click', (e)=>{ e.stopPropagation(); open(); });

      diag(`[EN VIVO] ${crewName} @ ${date} → 1 trabajo`);
    } class="btn-green px-3 py-2 rounded-xl text-white text-sm font-semibold shadow-md active:scale-[.99]" id="openFormBtn">Llenar</button>
        </div>`;
      list.appendChild(li);

      // Open modal on card or button
      const open = () => openJobModal(job);
      li.addEventListener('click', open);
      li.querySelector('#openFormBtn').addEventListener('click', (e)=>{ e.stopPropagation(); open(); });

      diag(`[EN VIVO] ${crewName} @ ${date} → 1 trabajo`);
    }

    // Modal + form
    function openJobModal(job){
      $('jobForm').reset();
      TEAM_SELECTED = [];
      renderTeamTokens();
      buildCrewOptions();

      $('jobId').value      = job.jobId || '';
      $('jobNumber').value  = job.jobNumber || '';
      $('jobAddress').value = job.address || '';
      $('jobRep').value     = job.rep || '';
      $('modalTitle').textContent = `Trabajo ${job.jobNumber || ''}`;
      const repLineEl = $('repLine'); if (repLineEl) repLineEl.textContent = 'Vendedor: ' + (job.rep || '—');

      const payCollected = $('paymentCollected');
      const payType = $('paymentType');
      const enablePayType = () => { payType.disabled = (payCollected.value !== 'Sí'); if (payType.disabled) payType.value = ''; };
      payCollected.onchange = enablePayType; enablePayType();

      $('modal').classList.remove('hidden');
    }
    $('closeModal').addEventListener('click', ()=> $('modal').classList.add('hidden'));

    function buildCrewOptions(){
      const me = $('crewSelect').value || '';
      const ul = $('crewOptions');
      ul.innerHTML = '';
      (ALL_CREW.filter(n => n !== me)).forEach(name => {
        const li=document.createElement('li');
        li.className='px-3 py-2 text-sm cursor-pointer hover:bg-slate-50';
        li.textContent=name;
        li.onclick=()=>toggleTeamMember(name);
        ul.appendChild(li);
      });
      $('crewDropdownBtn').onclick = ()=> $('crewDropdown').classList.toggle('hidden');
      $('crewSearch').oninput = (e)=>{
        const q=e.target.value.toLowerCase();
        Array.from(ul.children).forEach(li=> li.classList.toggle('hidden', !li.textContent.toLowerCase().includes(q)));
      };
    }
    function toggleTeamMember(name){
      const i = TEAM_SELECTED.indexOf(name);
      if (i === -1) TEAM_SELECTED.push(name); else TEAM_SELECTED.splice(i,1);
      renderTeamTokens();
    }
    function renderTeamTokens(){
      const box=$('crewTokens'); box.innerHTML='';
      TEAM_SELECTED.forEach(name=>{
        const chip=document.createElement('span');
        chip.className='inline-flex items-center gap-1 bg-emerald-100 text-emerald-800 rounded-full px-2 py-1 text-xs';
        chip.innerHTML = `${name} <button type="button" class="ml-1">✕</button>`;
        chip.querySelector('button').onclick = ()=> toggleTeamMember(name);
        box.appendChild(chip);
      });
      $('crewDropdownPlaceholder').textContent = TEAM_SELECTED.length ? '' : 'Toca para seleccionar…';
    }

    // Submit
    $('jobForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const crew = $('crewSelect').value;
      const notes = $('damageNotes').value.trim();
      if (notes.length < 10) return showToast('Escribe al menos 10 caracteres en Daños/Notas.');

      const payload = {
        action: 'submitJob',
        crew,
        jobId:      $('jobId').value,
        jobNumber:  $('jobNumber').value,
        jobAddress: $('jobAddress').value,
        rep:        $('jobRep').value,
        teamMembers: TEAM_SELECTED,
        startTime:  $('startTime').value,
        endTime:    $('endTime').value,
        damageNotes: notes,
        status:     $('status').value,
        paymentCollected: $('paymentCollected').value,
        paymentType:      $('paymentType').value
      };

      try{
        const res = await fetch(GAS_ENDPOINT, {
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body: JSON.stringify(payload)
        });
        const json = await (async () => { try { return await res.json(); } catch(_) { const t = await res.text(); return { ok:false, error:`Respuesta no JSON (${res.status}): ${t.slice(0,200)}` }; } })();
        if (!json || json.ok !== true) throw new Error(json && json.error || `HTTP ${res.status}`);
        showToast('Enviado ✅');
        $('modal').classList.add('hidden');
        fetchSchedule(crew); // desbloquea el siguiente trabajo
      }catch(err){
        console.error(err);
        showToast('No se pudo enviar');
      }
    });

    // Wire up
    document.addEventListener('DOMContentLoaded', ()=>{
      fetchCrew();
      $('crewSelect').addEventListener('change', (e)=> fetchSchedule(e.target.value));
      $('refreshBtn').addEventListener('click', ()=> { const n=$('crewSelect').value; if(n) fetchSchedule(n); });
    });
  </script>
</body>
</html>
